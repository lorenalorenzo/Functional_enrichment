---
title: "Enrichment in introgressed regions"
author: "Lorena Lorenzo Fern√°ndez"
date: "`r format(Sys.time(), '%d-%b-%Y')`"
output:
  github_document:
---

```{r global-options, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

## Testing for over and under representation on introgressed regions between Iberian and Eurasian lynxes

**DISCLAIMER: This is part of Enrico's proyect in detecting and characterising introgression in lynxes. Go to ebazzicalupo GitHub page for more information.**

Here, we are analyzing the excess or lack of functions in GO terms in a list of genes obtained from the introgressed regions. The data consist of:

1.  List of genes introgressed from Eurasian to Iberian ("ab.geneids.txt")
2.  List of genes introgressed from Iberian to Eurasian ("ba.geneids.txt")
3.  List of genes introgressed in both directions ("bi.geneids.txt")
4.  Table with the annotation of the genes and the corresponding GO terms ("LYRU_2A.FA.genego_table.tsv")

```{r}
# Load necessary libraries
library(topGO)
library(tidyverse)

```

```{r}

#Define input and output files
gene_set <- "your_candidate_genes.txt"
gene2GO_df <- read.delim("your gene to GO table from annotation.tsv", header = TRUE, sep = "\t")
output_name<- "your enrichment results filename"

# Convert the gene2GO data frame into a named list where each gene ID points to a vector of GO terms
gene2GO <- setNames(strsplit(gene2GO_df$go_terms, ";"), gene2GO_df$gene_id) 

# Get the list of all unique genes from the gene2GO mapping
allGenesList <- unique(gene2GO_df$gene_id)

# Read the list of candidate genes for the current gene set
candidateGenes <- readLines(gene_set)
  
# Create a named vector (geneList) for all genes:
  # 1 for candidate genes, 0 for non-candidate genes
  geneList <- setNames(as.numeric(allGenesList %in% candidateGenes), allGenesList)
  
  # Create the topGOdata object for both overrepresentation and underrepresentation tests
  GOdata <- new(
    "topGOdata",
    ontology = "BP",  # Choose "BP", "MF", or "CC" as appropriate
    allGenes = geneList,  # The named vector of all genes with 1 for candidates, 0 for non-candidates
    geneSel = function(p) p == 1,  # Function to select candidate genes (where p == 1)
    annot = annFUN.gene2GO,  # Annotation function for gene2GO mappings
    gene2GO = gene2GO  # Your gene-to-GO mappings
  )
  
  # Perform Overrepresentation Test 
  over_test <- runTest(GOdata, statistic = "fisher") #algorithm = "weight01" by default

  #Check FDR correction
  p_values <- score(over_test)
  fdr_corrected <- p.adjust(p_values, method = "fdr")
 
  #Create a table with significant results
 result_table <- GenTable(GOdata, Fisher=over_test, topNodes=over_test@geneData[2], numChar=1000) %>% 
        as_tibble() %>% 
        filter(Fisher<0.05 & Significant >1) 
 
  # Save the results to files
  write.table(result_table, paste0(output_name), sep = "\t", quote = FALSE, row.names = FALSE)
```

```{r, results= "hide"}

# Custom method to perform Fisher's exact test for underrepresentation (less frequent GO terms)
if (!isGeneric("GOFisherUnder")) {
  setGeneric("GOFisherUnder", function(object) standardGeneric("GOFisherUnder"))
}

setMethod("GOFisherUnder", "classicCount", function(object) {
  contMat <- contTable(object)
  if (all(contMat == 0)) {
    p.value <- 1
  } else {
    p.value <- fisher.test(contMat, alternative = "less")$p.value
  }
  return(p.value)
})
### tryals with underrepresentation
 # Set up a new test for underrepresentation using the custom GOFisherUnder function
  test.stat <- new("classicCount", testStatistic = GOFisherUnder, name = "Fisher's exact test for underrepresentation")
  
  # Perform Underrepresentation Test using the "classic" algorithm and custom GOFisherUnder function
  resultFisherUnder <- getSigGroups(GOdata, test.stat)

  result_under <- GenTable(GOdata, Fisher=resultFisherUnder, topNodes=resultFisherUnder@geneData[2], numChar=1000) %>% 
        as_tibble() %>% 
        mutate(p.adj = round(p.adjust(as.numeric(gsub("<", "", Fisher)), method="BH"), 15)) %>%
        filter(p.adj<0.05) 
```
